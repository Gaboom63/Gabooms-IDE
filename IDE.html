<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Web IDE v15.3 (Safe Save Edition)</title>
    <script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
    <style>
        :root { --bg-app: #1e1e1e; --bg-sidebar: #252526; --bg-header: #3c3c3c; --text-main: #cccccc; --accent: #007acc; --border: #3e3e42; --hover: #2a2d2e; --input-bg: #3c3c3c; --shadow: 0 4px 6px rgba(0,0,0,0.3); --tab-inactive: #2d2d2d; --tab-active: #1e1e1e; }
        * { box-sizing: border-box; }
        
        /* --- SCROLLBAR NUKE ZONE --- */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }
        .monaco-editor .scrollbar .slider { background: transparent !important; }
        .monaco-editor .scrollbar .scrollbar-background { background: transparent !important; }
        .monaco-editor .decorationsOverviewRuler { display: none !important; } 
        
        body { margin: 0; padding: 0; background-color: var(--bg-app); color: var(--text-main); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        header { height: 35px; background-color: var(--bg-header); display: flex; align-items: center; padding: 0 15px; font-size: 13px; border-bottom: 1px solid var(--border); justify-content: space-between; user-select: none; z-index: 10; }
        .header-left { display: flex; gap: 10px; align-items: center; }
        .menu-btn, select { background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); cursor: pointer; padding: 3px 10px; border-radius: 3px; font-size: 12px; outline: none; transition: opacity 0.2s; }
        .menu-btn:hover { opacity: 0.8; background: var(--hover); }

        /* Layout */
        .main-container { display: flex; flex: 1; height: calc(100vh - 57px); position: relative; }
        .sidebar { width: 250px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: relative; overflow: hidden; flex-shrink: 0; transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.2s; }
        .sidebar.collapsed { width: 0; border: none; opacity: 0; }
        .sidebar-header { padding: 10px; font-weight: bold; font-size: 11px; opacity: 0.7; display: flex; justify-content: space-between; align-items: center; min-width: 250px; }
        
        /* Search */
        .search-trigger { cursor: pointer; opacity: 0.8; font-size: 14px; padding:5px; border-radius:3px; }
        .search-trigger:hover { background: var(--hover); color: var(--accent); }
        .search-box-container { display: none; padding: 5px 10px; background: var(--bg-sidebar); border-bottom: 1px solid var(--border); }
        .search-box-container.visible { display: block; }
        #searchInput { width: 100%; background: var(--input-bg); border: 1px solid var(--accent); color: var(--text-main); padding: 4px; border-radius: 2px; outline: none; }
        
        /* File Tree */
        .file-explorer { flex: 1; overflow-y: auto; padding-top: 5px; min-width: 250px; }
        .search-results { flex: 1; overflow-y: auto; display: none; background: var(--bg-sidebar); min-width: 250px; }
        .search-results.visible { display: block; }
        .tree-item { padding: 4px 10px; cursor: pointer; font-size: 13px; display: flex; align-items: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background 0.1s ease; }
        .tree-item:hover { background-color: var(--hover); }
        .tree-item.directory { font-weight: 600; }
        .search-match { border-left: 3px solid var(--accent); background: var(--hover); }

        /* Workspace & Tabs */
        .center-stage { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .tab-bar { height: 35px; background-color: var(--bg-sidebar); display: flex; align-items: flex-end; overflow-x: auto; overflow-y: hidden; border-bottom: 1px solid var(--border); }
        .tab {
            height: 100%; display: flex; align-items: center; padding: 0 10px; 
            background-color: var(--tab-inactive); color: #888; border-right: 1px solid var(--border); 
            font-size: 12px; cursor: pointer; min-width: 100px; max-width: 200px; user-select: none;
            position: relative;
        }
        .tab:hover { background-color: var(--hover); }
        .tab.active { background-color: var(--tab-active); color: var(--text-main); border-top: 2px solid var(--accent); }
        .tab-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 8px; }
        
        /* Close Button & Unsaved Dot Logic */
        .tab-close { margin-left: auto; font-size: 14px; border-radius: 50%; padding: 0 4px; color: inherit; opacity: 0.7; display: block; }
        .tab-close:hover { background: rgba(255,255,255,0.2); opacity: 1; }
        
        /* The Unsaved Dot */
        .unsaved-dot { width: 8px; height: 8px; background-color: white; border-radius: 50%; display: none; margin-left: auto; }
        
        /* Dirty State: Show Dot, Hide X (unless hovered) */
        .tab.dirty .unsaved-dot { display: block; }
        .tab.dirty .tab-close { display: none; }
        
        /* Hover on Dirty Tab: Show X again */
        .tab.dirty:hover .unsaved-dot { display: none; }
        .tab.dirty:hover .tab-close { display: block; }

        .workspace-area { flex: 1; display: flex; flex-direction: row; background-color: var(--bg-app); overflow: hidden; }
        .editor-column { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        #mediaContainer { flex: 1; display: none; align-items: center; justify-content: center; flex-direction: column; background: var(--bg-app); overflow: auto; padding: 20px; }
        #mediaContainer img { max-width: 90%; max-height: 90%; border: 1px solid var(--border); box-shadow: var(--shadow); background-image: linear-gradient(45deg, #2e2e2e 25%, transparent 25%), linear-gradient(-45deg, #2e2e2e 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #2e2e2e 75%), linear-gradient(-45deg, transparent 75%, #2e2e2e 75%); background-size: 20px 20px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .audio-player-box { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; background:var(--bg-sidebar); border-radius:10px; border:1px solid var(--border); box-shadow: var(--shadow); }
        
        .right-panel { width: 0; display: none; flex-direction: column; border-left: 1px solid var(--border); background-color: #ffffff; transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .right-panel.open { width: 50%; display: flex; }
        .panel-header { height: 35px; background: #f0f0f0; border-bottom: 1px solid #ccc; display: flex; align-items: center; padding: 0 5px; }
        .browser-bar { display: flex; flex: 1; gap: 5px; align-items: center; }
        .url-input { flex: 1; border: 1px solid #ccc; padding: 4px 8px; font-size: 12px; border-radius: 3px; }
        .icon-btn { border: none; background: none; cursor: pointer; color: #555; font-weight: bold; padding: 0 8px; font-size: 14px; border-radius:3px; transition:background 0.2s; }
        .icon-btn:hover { background: #e0e0e0; }
        iframe { flex: 1; border: none; width: 100%; height: 100%; background: white; }
        
        /* Console */
        .console-pane { height: 0; background-color: var(--bg-app); border-top: 1px solid var(--border); display: none; flex-direction: column; font-family: 'Consolas', monospace; font-size: 12px; transition: height 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .console-pane.open { height: 150px; display: flex; }
        .console-output { flex: 1; overflow-y: auto; padding: 5px; color: var(--text-main); }
        .console-input-line { display: flex; border-top: 1px solid var(--border); padding: 5px; }
        #consoleInput { flex: 1; background: transparent; border: none; color: var(--text-main); outline: none; }
        
        footer { height: 22px; background-color: var(--accent); color: white; display: flex; align-items: center; padding: 0 10px; font-size: 12px; justify-content: space-between; z-index: 10; }
        .footer-item { display: flex; gap: 15px; cursor: pointer; }
        .footer-btn:hover { text-decoration: underline; }
        .resume-btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.1s, background 0.2s; }
        .resume-btn:hover { transform: translateY(-1px); background: #0062a3; }
        
        /* Spinner */
        #loadingOverlay {
            position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7);
            display: none; align-items: center; justify-content: center; z-index: 100; flex-direction: column;
        }
        .spinner { width: 30px; height: 30px; border: 4px solid var(--accent); border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Settings Modal */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 200; display:none; align-items:center; justify-content:center; }
        .modal { background: var(--bg-sidebar); border: 1px solid var(--border); width: 600px; max-width: 90%; padding: 20px; border-radius: 5px; box-shadow: var(--shadow); }
        .modal h3 { margin-top: 0; color: var(--text-main); border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* Settings Tabs */
        .settings-tab-bar { display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--border); }
        .settings-tab-bar button { background: none; border: none; color: var(--text-main); padding: 8px 15px; cursor: pointer; opacity: 0.6; transition: opacity 0.2s, color 0.2s; }
        .settings-tab-bar button.active { opacity: 1; color: var(--accent); border-bottom: 2px solid var(--accent); margin-bottom: -1px; }

        /* Settings Content */
        .settings-content > div { display: none; }
        .settings-content > div.active { display: block; }

        /* General & Color Tab Layout */
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 13px; }
        .color-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .color-group h4 { margin-top: 0; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        
        .color-setting { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .color-setting label { font-size: 13px; }
        .color-input { width: 40px; height: 20px; padding: 0; border: 1px solid var(--border); cursor: pointer; }
        
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }
        .close-modal-btn { background: var(--accent); color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; float: right; margin-top: 15px; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <button class="menu-btn" onclick="toggleSidebar()" title="Toggle Sidebar (Ctrl+B)">‚ò∞</button>
        <button class="menu-btn" onclick="openFolder()">üìÇ Open Folder</button>
        <button class="menu-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
    </div>
    <div class="header-right">
        <select id="themeSelect" onchange="changeTheme(this.value)">
            <option value="vs-dark">Theme: Dark</option>
            <option value="vs-light">Theme: Light</option>
            <option value="dracula">Theme: Dracula</option>
            <option value="monokai">Theme: Monokai</option>
            <option value="solarized">Theme: Solarized</option>
            <option value="synthwave">Theme: SynthWave '84</option>
            <option value="seti">Theme: Seti</option>
            <option value="tomorrow-night">Theme: Tomorrow Night</option>
            <option value="ambiance">Theme: Ambiance</option>
            <option value="custom">Theme: Custom (Active)</option>
        </select>
    </div>
</header>

<div class="main-container">
    <div class="sidebar" id="mainSidebar">
        <div class="sidebar-header">
            <span>EXPLORER</span>
            <span class="search-trigger" onclick="toggleSearch()" title="Search Files (Ctrl+P)">üîç</span>
        </div>
        <div class="search-box-container" id="searchBoxContainer">
            <input type="text" id="searchInput" placeholder="Search path..." autocomplete="off">
        </div>
        <div class="file-explorer" id="fileExplorer">
            <div style="padding:20px; text-align:center; opacity:0.5;">No Folder</div>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <div class="center-stage">
        <div class="tab-bar" id="tabBar"></div>

        <div class="workspace-area">
            <div class="editor-column">
                <div id="monaco-container" style="flex:1; display:none;"></div>
                <div id="mediaContainer"></div>
                <div id="emptyState" style="flex:1; display:flex; align-items:center; justify-content:center; opacity:0.5; flex-direction:column;">
                    <h2>Web IDE v15.3</h2>
                    <p>Open a folder to start.</p>
                    <div id="resumeSection" style="display:none; text-align:center; margin-top:20px;">
                        <p>Welcome back!</p>
                        <button class="resume-btn" onclick="resumeProject()">Resume Previous Project</button>
                    </div>
                </div>
                <div id="loadingOverlay">
                    <div class="spinner"></div>
                    <div id="loadingText" style="color:white;">Processing Assets...</div>
                </div>
            </div>

            <div class="right-panel" id="rightPanel">
                <div class="panel-header">
                    <div class="browser-bar" id="browserControls">
                        <button class="icon-btn" onclick="browserBack()">‚Üê</button>
                        <button class="icon-btn" onclick="browserRefresh()">‚Üª</button>
                        <input type="text" class="url-input" id="urlInput" placeholder="https://" onkeydown="if(event.key==='Enter') loadUrl()">
                        <label title="Bypass X-Frame-Options" style="font-size:10px; display:flex; align-items:center;">
                            <input type="checkbox" id="proxyCheck"> Proxy
                        </label>
                        <button class="icon-btn" onclick="loadUrl()">Go</button>
                        <button class="icon-btn" onclick="closeRightPanel()" style="color:red; margin-left:auto;">‚úï</button>
                    </div>
                    <div id="livePreviewControls" style="display:none; flex:1; align-items:center;">
                        <strong style="margin-left:10px;">Live Preview</strong>
                        <button class="icon-btn" onclick="fullRefresh()" style="margin-left:10px;">‚Üª Full Reload</button>
                        <button class="icon-btn" onclick="closeRightPanel()" style="color:red; margin-left:auto;">‚úï</button>
                    </div>
                </div>
                <iframe id="webFrame"></iframe>
            </div>
        </div>

        <div class="console-pane" id="consolePane">
            <div style="padding:5px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">
                <span>DEBUG CONSOLE</span>
                <button onclick="document.getElementById('consoleOutput').innerHTML=''" style="background:none;border:none;color:var(--text-main);cursor:pointer;">üö´ Clear</button>
            </div>
            <div class="console-output" id="consoleOutput"></div>
            <div class="console-input-line">
                <span style="color: var(--accent); margin-right:5px;">></span>
                <input type="text" id="consoleInput" placeholder="Execute JS..." autocomplete="off">
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="footer-item">
        <div class="footer-btn" onclick="toggleConsole()">Terminal</div>
    </div>
    <div class="footer-item">
        <div class="footer-btn" onclick="openBrowser()">üåê Web Browser</div>
        <div class="footer-btn" onclick="startLiveServer()">‚ö° Go Live</div>
        <div id="lang-display">TXT</div>
    </div>
</footer>

<div class="modal-overlay" id="settingsModal">
    <div class="modal">
        <h3>Settings</h3>
        <div class="settings-tab-bar">
            <button class="settings-tab-btn" id="tabGeneral" onclick="showSettingsTab('general', this)">General</button>
            <button class="settings-tab-btn" id="tabColors" onclick="showSettingsTab('colors', this)">Colors (Custom)</button>
        </div>
        <div class="settings-content">
            <div id="generalSettings">
                <div class="setting-row">
                    <span>Auto Save</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="settingAutoSave" onchange="toggleAutoSave()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-row">
                    <span>Word Wrap</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="settingWordWrap" onchange="toggleWordWrap()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-row">
                    <span>Font Size</span>
                    <select id="settingFontSize" onchange="changeFontSize(this.value)" style="width:80px;">
                        <option value="12">12px</option>
                        <option value="14" selected>14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                    </select>
                </div>
            </div>
            
            <div id="colorSettings">
                <p style="font-size:12px; margin-bottom: 20px;">Edit these colors to customize the "Custom" theme. Changes are applied immediately.</p>
                <div class="color-grid">
                    <div class="color-group">
                        <h4>UI Colors</h4>
                        <div class="color-setting">
                            <label for="colorSidebar">Sidebar / Tab Background</label>
                            <input type="color" id="colorSidebar" class="color-input" value="#252526" oninput="updateCustomTheme()">
                        </div>
                         <div class="color-setting">
                            <label for="colorApp">App / Editor Background</label>
                            <input type="color" id="colorApp" class="color-input" value="#1e1e1e" oninput="updateCustomTheme()">
                        </div>
                        <div class="color-setting">
                            <label for="colorAccent">Accent / Footer Color</label>
                            <input type="color" id="colorAccent" class="color-input" value="#007acc" oninput="updateCustomTheme()">
                        </div>
                        <div class="color-setting">
                            <label for="colorText">Main Text Color</label>
                            <input type="color" id="colorText" class="color-input" value="#cccccc" oninput="updateCustomTheme()">
                        </div>
                    </div>

                    <div class="color-group">
                        <h4>Code Colors (Monaco Tokens)</h4>
                        <div class="color-setting">
                            <label for="colorKeyword">Keywords (const, function)</label>
                            <input type="color" id="colorKeyword" class="color-input" value="#C586C0" oninput="updateCustomTheme()">
                        </div>
                        <div class="color-setting">
                            <label for="colorString">Strings ("text")</label>
                            <input type="color" id="colorString" class="color-input" value="#CE9178" oninput="updateCustomTheme()">
                        </div>
                        <div class="color-setting">
                            <label for="colorComment">Comments (//, /* */)</label>
                            <input type="color" id="colorComment" class="color-input" value="#6A9955" oninput="updateCustomTheme()">
                        </div>
                        <div class="color-setting">
                            <label for="colorFunction">Function/Method Names</label>
                            <input type="color" id="colorFunction" class="color-input" value="#DCDCAA" oninput="updateCustomTheme()">
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        <button class="close-modal-btn" onclick="document.getElementById('settingsModal').style.display='none'">Close</button>
    </div>
</div>

<script>
    // --- Global Variables ---
    let editor;
    let tabs = []; 
    let activeTabPath = null; 
    let currentObjectUrl = null; 
    let fileIndex = []; 
    let projectRootHandle = null; 
    let rightPanelMode = 'none';
    let autoSaveTimer = null;

    // Settings Defaults & Custom Color Storage
    let settings = {
        autoSave: false,
        wordWrap: false,
        fontSize: 14,
        customTheme: {
            app: '#1e1e1e',
            sidebar: '#252526',
            accent: '#007acc',
            text: '#cccccc',
            keyword: '#C586C0',
            string: '#CE9178',
            comment: '#6A9955',
            function: '#DCDCAA'
        }
    };

    // --- BROWSER EXIT PROTECTION ---
    // Prevents closing the window/tab if any files are unsaved
    window.onbeforeunload = function(e) {
        if (tabs.some(t => t.isDirty)) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes!';
            return 'You have unsaved changes!';
        }
    };

    // --- ASSET MANAGER ---
    const AssetManager = {
        cache: new Map(), 
        clear() { this.cache.forEach(url => URL.revokeObjectURL(url)); this.cache.clear(); },
        isHeavy(ext) { return ['png', 'jpg', 'jpeg', 'gif', 'svg', 'ico', 'mp3', 'wav', 'ogg', 'ttf', 'woff', 'woff2', 'otf', 'eot'].includes(ext); },
        isCode(ext) { return ['js', 'json', 'css', 'html', 'txt', 'md'].includes(ext); },
        getMimeType(ext) {
            const mimes = {
                'css': 'text/css', 'js': 'text/javascript', 'json': 'application/json',
                'png': 'image/png', 'jpg': 'image/jpeg', 'jpeg': 'image/jpeg', 'gif': 'image/gif', 'svg': 'image/svg+xml',
                'mp3': 'audio/mpeg', 'wav': 'audio/wav'
            };
            return mimes[ext] || 'application/octet-stream';
        },
        async fetchAndCache(item) {
            const key = item.path; 
            if (this.cache.has(key)) return this.cache.get(key);
            try {
                const file = await item.handle.getFile();
                const ext = item.path.split('.').pop().toLowerCase();
                let blob;
                if (ext === 'css') {
                    let cssText = await file.text();
                    cssText = cssText.replace(/url\(['"]?([^'")]+)['"]?\)/g, (match, url) => {
                        const cleanUrl = url.split('?')[0].split('#')[0];
                        const resolved = resolvePath(item.path, cleanUrl);
                        const cachedUrl = this.lookup(resolved);
                        return cachedUrl ? `url('${cachedUrl}')` : match;
                    });
                    blob = new Blob([cssText], { type: 'text/css' });
                } else {
                    blob = new Blob([await file.arrayBuffer()], { type: this.getMimeType(ext) });
                }
                const url = URL.createObjectURL(blob);
                this.cache.set(key, url);
                this.cache.set(key.toLowerCase(), url); 
                return url;
            } catch (e) {
                console.error("Failed to load asset", item.path, e);
                return null;
            }
        },
        lookup(path) { if (!path) return null; return this.cache.get(path) || this.cache.get(path.toLowerCase()); }
    };

    // --- SYSTEM LOGGER ---
    window.runtimeLogger = (type, args) => {
        const out = document.getElementById('consoleOutput');
        const line = document.createElement('div');
        line.style.borderBottom = '1px solid #333';
        line.style.fontFamily = 'monospace';
        line.style.padding = '2px';
        line.style.whiteSpace = 'pre-wrap';
        
        if(type==='error') line.style.color = '#ff6b6b';
        else if(type==='warn') line.style.color = '#feca57';
        else if(type==='>') line.style.color = '#007acc'; 
        else if(type==='<') line.style.color = '#888'; 
        else line.style.color = '#cccccc';

        const text = args.map(arg => {
            if (arg === null) return 'null';
            if (arg === undefined) return 'undefined';
            if (typeof arg === 'object') {
                try { return JSON.stringify(arg, null, 2); } catch(e) { return '[object Object]'; }
            }
            return String(arg);
        }).join(' ');
        
        line.textContent = (['>','<'].includes(type) ? '' : `[${type.toUpperCase()}] `) + text;
        out.appendChild(line);
        out.scrollTop = out.scrollHeight;
    };

    document.getElementById('consoleInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const code = this.value;
            if (!code) return;
            window.runtimeLogger('>', [code]);
            try {
                const frame = document.getElementById('webFrame');
                if (rightPanelMode === 'live' && frame.contentWindow) {
                    const result = frame.contentWindow.eval(code);
                    window.runtimeLogger('<', [result]);
                } else {
                    window.runtimeLogger('error', ['Live preview is not active or accessible.']);
                }
            } catch (err) {
                window.runtimeLogger('error', [err.message]);
            }
            this.value = '';
        }
    });

    // --- MONACO THEME DEFINITION ---
    function defineMonacoThemes() {
        if (!window.monaco) return;
        
        const themeDefinitions = {
            'dracula': {
                base: 'vs-dark', inherit: true,
                rules: [
                    { token: 'comment', foreground: '6272a4' }, 
                    { token: 'keyword', foreground: 'ff79c6' }, 
                    { token: 'string', foreground: 'f1fa8c' }, 
                    { token: 'number', foreground: 'bd93f9' }, 
                    { token: 'type', foreground: '8be9fd' }, 
                    { token: 'identifier', foreground: 'f8f8f2' },
                    { token: 'type.function', foreground: '50fa7b' } 
                ],
                colors: { 'editor.background': '#282a36', 'editor.foreground': '#f8f8f2', 'editorLineNumber.foreground': '#6272a4' }
            },
            'monokai': {
                base: 'vs-dark', inherit: true,
                rules: [
                    { token: 'comment', foreground: '75715e' },
                    { token: 'keyword', foreground: 'f92672' },
                    { token: 'string', foreground: 'e6db74' },
                    { token: 'number', foreground: 'ae81ff' },
                    { token: 'type', foreground: '66d9ef' },
                    { token: 'identifier', foreground: 'f8f8f2' },
                    { token: 'type.function', foreground: 'a6e22e' }
                ],
                colors: { 'editor.background': '#272822', 'editor.foreground': '#f8f8f2', 'editorLineNumber.foreground': '#75715e' }
            },
            'solarized': { base: 'vs-dark', inherit: true, rules: [], colors: { 'editor.background': '#002b36', 'editor.foreground': '#839496' } },
            'synthwave': { base: 'vs-dark', inherit: true, rules: [], colors: { 'editor.background': '#262335', 'editor.foreground': '#fff' } },
            'seti': { base: 'vs-dark', inherit: true, rules: [], colors: { 'editor.background': '#151718', 'editor.foreground': '#CDD4D7' } },
            'tomorrow-night': { base: 'vs-dark', inherit: true, rules: [], colors: { 'editor.background': '#1d1f21', 'editor.foreground': '#c5c8c6' } },
            'ambiance': { base: 'vs-dark', inherit: true, rules: [], colors: { 'editor.background': '#1c1c1c', 'editor.foreground': '#f8f8f8' } }
        };

        Object.keys(themeDefinitions).forEach(t => { monaco.editor.defineTheme(t, themeDefinitions[t]); });
        
        monaco.editor.defineTheme('custom', {
            base: 'vs-dark', 
            inherit: false, 
            rules: [
                { token: 'comment', foreground: settings.customTheme.comment.substring(1) },
                { token: 'keyword', foreground: settings.customTheme.keyword.substring(1) }, 
                { token: 'string', foreground: settings.customTheme.string.substring(1) },
                { token: 'identifier', foreground: settings.customTheme.text.substring(1) }, 
                { token: 'type.function', foreground: settings.customTheme.function.substring(1) }
            ],
            colors: {
                'editor.background': settings.customTheme.app,
                'editor.foreground': settings.customTheme.text,
                'editorLineNumber.foreground': settings.customTheme.text + '88',
                'editorCursor.foreground': settings.customTheme.accent,
                'selection.background': settings.customTheme.accent + '40',
                'editor.selectionHighlightBackground': settings.customTheme.accent + '20'
            }
        });
    }

    // --- INIT ---
    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@latest/min/vs' }});
    require(['vs/editor/editor.main'], function() {
        defineMonacoThemes();
        
        editor = monaco.editor.create(document.getElementById('monaco-container'), {
            value: '', language: 'plaintext', theme: 'vs-dark',
            automaticLayout: true, 
            minimap: { enabled: true }, 
            smoothScrolling: true, cursorBlinking: 'smooth', cursorSmoothCaretAnimation: 'on',
            padding: { top: 10 },
            fontSize: settings.fontSize,
            wordWrap: settings.wordWrap ? 'on' : 'off'
        });
        
        // --- NEW: CHANGE LISTENER FOR SAVING LOGIC ---
        editor.onDidChangeModelContent(() => {
            const tab = tabs.find(t => t.path === activeTabPath);
            if (!tab) return;

            if (settings.autoSave) {
                // Debounce auto-save
                if (autoSaveTimer) clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    saveTab(activeTabPath);
                }, 1000); // Save 1 second after stopping typing
            } else {
                // Manual Save Mode: Mark dirty immediately
                if (!tab.isDirty) {
                    tab.isDirty = true;
                    renderTabs(); // Update UI to show white circle
                }
            }
        });

        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => saveTab(activeTabPath));
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyP, toggleSearch);
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyB, toggleSidebar);

        let currentLinks = []; 
        editor.onMouseDown(e => {
            if (!e.event.ctrlKey && !e.event.metaKey) return; 
            if (e.target.type !== monaco.editor.MouseTargetType.CONTENT_TEXT) return;
            const model = editor.getModel();
            const pos = e.target.position;
            const offset = model.getOffsetAt(pos);
            for (const link of currentLinks) {
                const start = model.getOffsetAt(new monaco.Position(link.range.startLineNumber, link.range.startColumn));
                const end = model.getOffsetAt(new monaco.Position(link.range.endLineNumber, link.range.endColumn));
                if (offset >= start && offset <= end) {
                    const filePath = link.url.substring("file://".length); 
                    const found = fileIndex.find(f => f.path.toLowerCase() === filePath.toLowerCase());
                    if (found) loadFile(found.handle, found.path); 
                    e.event.preventDefault(); 
                    break;
                }
            }
        });
        
        monaco.languages.registerLinkProvider('*', {
            provideLinks(model) {
                const text = model.getValue();
                const regex = /(['"])([\w\d\.\-\/_]+)\1/g;
                let match;
                const links = [];
                currentLinks = []; 
                while ((match = regex.exec(text)) !== null) {
                    const rawPath = match[2];
                    const resolved = resolvePath(activeTabPath, rawPath);
                    const found = fileIndex.find(f => f.path.toLowerCase() === resolved.toLowerCase());
                    if (!found) continue;
                    const start = model.getPositionAt(match.index + 1);
                    const end = model.getPositionAt(match.index + 1 + rawPath.length);
                    const link = {
                        range: { startLineNumber: start.lineNumber, startColumn: start.column, endLineNumber: end.lineNumber, endColumn: end.column },
                        tooltip: "Open " + found.path, url: "file://" + found.path 
                    };
                    links.push(link); currentLinks.push(link);
                }
                return { links };
            }
        });
        
        loadSettingsFromStorage();
        applySettingsToUI();
        
        const req = indexedDB.open('WebIDE_DB', 1);
        req.onsuccess = (e) => {
            e.target.result.transaction('handles', 'readonly').objectStore('handles').get('last_project').onsuccess = (ev) => {
                if (ev.target.result) document.getElementById('resumeSection').style.display = 'block';
            };
        };
        req.onupgradeneeded = (e) => e.target.result.createObjectStore('handles');
    });

    // --- TAB MANAGEMENT ---
    async function loadFile(handle, explicitPath) {
        const path = explicitPath || (fileIndex.find(i => i.handle.name === handle.name) || {}).path;
        const existingTab = tabs.find(t => t.path === path);
        if (existingTab) { switchToTab(path); return; }

        const ext = path.split('.').pop().toLowerCase();
        const isMedia = AssetManager.isHeavy(ext);
        
        let model = null;
        if (!isMedia) {
            const file = await handle.getFile();
            const text = await file.text();
            const lang = ext === 'js' ? 'javascript' : ext === 'html' ? 'html' : ext === 'css' ? 'css' : 'json';
            const uri = monaco.Uri.parse("file:///" + path);
            model = monaco.editor.getModel(uri) || monaco.editor.createModel(text, lang, uri);
        }

        const newTab = { path, handle, model, viewState: null, isDirty: false, kind: isMedia ? 'media' : 'code', name: handle.name };
        tabs.push(newTab);
        renderTabs();
        switchToTab(path);
    }

    async function switchToTab(path) {
        if (activeTabPath) {
            const currentTab = tabs.find(t => t.path === activeTabPath);
            if (currentTab && currentTab.kind === 'code' && editor) currentTab.viewState = editor.saveViewState();
        }
        activeTabPath = path;
        const tab = tabs.find(t => t.path === path);
        renderTabs(); 
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('monaco-container').style.display = 'none';
        document.getElementById('mediaContainer').style.display = 'none';

        const ext = tab.path.split('.').pop().toLowerCase();
        document.getElementById('lang-display').innerText = ext.toUpperCase();

        if (tab.kind === 'media') {
            document.getElementById('mediaContainer').style.display = 'flex';
            const url = await AssetManager.fetchAndCache({ handle: tab.handle, path: tab.path });
            const mediaContainer = document.getElementById('mediaContainer');
            if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'ico'].includes(ext)) {
                mediaContainer.innerHTML = `<img src="${url}"><div style="margin-top:10px;color:gray;">${tab.name}</div>`;
            } else {
                mediaContainer.innerHTML = `<div class="audio-player-box"><div style="font-size:60px; margin-bottom:20px;">üíø</div><audio controls autoplay src="${url}" style="width:300px; outline:none;"></audio><div style="margin-top:20px; color:var(--accent); font-weight:bold;">${tab.name}</div></div>`;
            }
        } else {
            document.getElementById('monaco-container').style.display = 'block';
            editor.setModel(tab.model);
            if (tab.viewState) editor.restoreViewState(tab.viewState);
            editor.focus();
            if (rightPanelMode === 'live') updateLivePreview();
        }
    }

    // --- UPDATED: SAFER CLOSE TAB LOGIC ---
    function closeTab(e, path) {
        e.stopPropagation(); 
        const tabIndex = tabs.findIndex(t => t.path === path);
        if (tabIndex === -1) return;
        
        const tab = tabs[tabIndex];
        
        // CHECK FOR DIRTY STATE BEFORE CLOSING
        if (tab.isDirty) {
            const confirmClose = confirm(`"${tab.name}" has unsaved changes. Are you sure you want to close it? Changes will be lost.`);
            if (!confirmClose) return;
        }

        if (activeTabPath === path) {
            if (tabs.length > 1) {
                const nextTab = tabs[tabIndex + 1] || tabs[tabIndex - 1];
                switchToTab(nextTab.path);
            } else {
                activeTabPath = null;
                document.getElementById('monaco-container').style.display = 'none';
                document.getElementById('mediaContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'flex';
                document.getElementById('lang-display').innerText = 'TXT';
            }
        }
        
        if (tab.model) tab.model.dispose(); 
        tabs.splice(tabIndex, 1);
        renderTabs();
    }

    function renderTabs() {
        const container = document.getElementById('tabBar');
        container.innerHTML = '';
        tabs.forEach(tab => {
            const el = document.createElement('div');
            el.className = `tab ${tab.path === activeTabPath ? 'active' : ''} ${tab.isDirty ? 'dirty' : ''}`;
            el.title = tab.path;
            el.onclick = () => switchToTab(tab.path);
            el.innerHTML = `<span class="tab-name">${tab.name}</span><span class="unsaved-dot"></span><span class="tab-close" onclick="closeTab(event, '${tab.path}')">‚úï</span>`;
            container.appendChild(el);
        });
    }

    async function saveTab(path) {
        const tab = tabs.find(t => t.path === path);
        if (!tab || tab.kind !== 'code') return;
        try {
            const w = await tab.handle.createWritable();
            await w.write(tab.model.getValue());
            await w.close();
            
            // Mark as clean immediately after successful save
            tab.isDirty = false;
            renderTabs(); // Removes the white dot

            if (AssetManager.cache.has(tab.path)) URL.revokeObjectURL(AssetManager.cache.get(tab.path));
            AssetManager.cache.delete(tab.path);
            if (AssetManager.isCode(tab.path.split('.').pop())) await AssetManager.fetchAndCache({handle: tab.handle, path: tab.path});
            if (rightPanelMode === 'live') updateLivePreview();
        } catch (e) { console.error("Save failed", e); alert("Failed to save file."); }
    }

    // --- SETTINGS ---
    function openSettings() { 
        document.getElementById('settingAutoSave').checked = settings.autoSave;
        document.getElementById('settingWordWrap').checked = settings.wordWrap;
        document.getElementById('settingFontSize').value = settings.fontSize;
        document.getElementById('colorApp').value = settings.customTheme.app;
        document.getElementById('colorSidebar').value = settings.customTheme.sidebar;
        document.getElementById('colorAccent').value = settings.customTheme.accent;
        document.getElementById('colorText').value = settings.customTheme.text;
        document.getElementById('colorKeyword').value = settings.customTheme.keyword;
        document.getElementById('colorString').value = settings.customTheme.string;
        document.getElementById('colorComment').value = settings.customTheme.comment;
        document.getElementById('colorFunction').value = settings.customTheme.function;
        document.getElementById('settingsModal').style.display = 'flex'; 
        const currentTheme = localStorage.getItem('webIDE_currentTheme');
        const defaultTabId = (currentTheme === 'custom' || !currentTheme) ? 'colors' : 'general';
        const buttonToClick = document.getElementById('tab' + defaultTabId.charAt(0).toUpperCase() + defaultTabId.slice(1));
        if (buttonToClick) showSettingsTab(defaultTabId, buttonToClick);
        else showSettingsTab('general', document.getElementById('tabGeneral'));
    }
    
    function showSettingsTab(tabId, button) {
        document.querySelectorAll('.settings-tab-btn').forEach(btn => btn.classList.remove('active'));
        const generalDiv = document.getElementById('generalSettings');
        const colorDiv = document.getElementById('colorSettings');
        if (generalDiv) generalDiv.classList.remove('active');
        if (colorDiv) colorDiv.classList.remove('active');
        if (button) button.classList.add('active');
        const targetDiv = document.getElementById(tabId + 'Settings');
        if (targetDiv) targetDiv.classList.add('active');
    }

    function toggleAutoSave() { 
        settings.autoSave = document.getElementById('settingAutoSave').checked;
        saveSettingsToStorage(); 
        // If turned on, save all dirty tabs immediately
        if(settings.autoSave) {
            tabs.forEach(t => { if(t.isDirty) saveTab(t.path); });
        }
    }
    function toggleWordWrap() { 
        settings.wordWrap = document.getElementById('settingWordWrap').checked; 
        if (editor) editor.updateOptions({ wordWrap: settings.wordWrap ? 'on' : 'off' });
        saveSettingsToStorage(); 
    }
    function changeFontSize(val) {
        settings.fontSize = parseInt(val);
        if (editor) editor.updateOptions({ fontSize: settings.fontSize });
        saveSettingsToStorage(); 
    }

    function updateCustomTheme() {
        settings.customTheme.app = document.getElementById('colorApp').value;
        settings.customTheme.sidebar = document.getElementById('colorSidebar').value;
        settings.customTheme.accent = document.getElementById('colorAccent').value;
        settings.customTheme.text = document.getElementById('colorText').value;
        settings.customTheme.keyword = document.getElementById('colorKeyword').value;
        settings.customTheme.string = document.getElementById('colorString').value;
        settings.customTheme.comment = document.getElementById('colorComment').value;
        settings.customTheme.function = document.getElementById('colorFunction').value;
        saveSettingsToStorage();
        defineMonacoThemes();
        if (editor) monaco.editor.setTheme('custom');
        document.getElementById('themeSelect').value = 'custom';
        applyUiTheme('custom');
    }
    
    function saveSettingsToStorage() {
        try { localStorage.setItem('webIDE_settings', JSON.stringify(settings)); } catch (e) { console.error("Could not save settings", e); }
    }

    function loadSettingsFromStorage() {
        try {
            const saved = localStorage.getItem('webIDE_settings');
            if (saved) {
                const loadedSettings = JSON.parse(saved);
                settings = { ...settings, ...loadedSettings };
                settings.customTheme = { ...settings.customTheme, ...loadedSettings.customTheme };
            }
        } catch (e) { console.error("Could not load settings", e); }
    }

    function applySettingsToUI() {
        document.getElementById('settingAutoSave').checked = settings.autoSave;
        document.getElementById('settingWordWrap').checked = settings.wordWrap;
        document.getElementById('settingFontSize').value = settings.fontSize;
        if (editor) editor.updateOptions({ fontSize: settings.fontSize, wordWrap: settings.wordWrap ? 'on' : 'off' });
        let currentTheme = 'vs-dark'; 
        if (localStorage.getItem('webIDE_currentTheme')) currentTheme = localStorage.getItem('webIDE_currentTheme');
        else if (settings.customTheme.app !== '#1e1e1e') currentTheme = 'custom'; 
        const themeSelect = document.getElementById('themeSelect');
        if ([...themeSelect.options].map(o => o.value).includes(currentTheme)) themeSelect.value = currentTheme;
        else { themeSelect.value = 'vs-dark'; currentTheme = 'vs-dark'; }
        changeTheme(currentTheme);
    }
    
    // --- CORE FUNCTIONS ---
    function toggleSidebar() {
        document.getElementById('mainSidebar').classList.toggle('collapsed');
        setTimeout(() => editor && editor.layout(), 310); 
    }
    
    async function openFolder() {
        try {
            const handle = await window.showDirectoryPicker();
            await loadProject(handle);
        } catch (e) { console.error(e); }
    }

    async function resumeProject() {
        const req = indexedDB.open('WebIDE_DB', 1);
        req.onsuccess = (e) => {
            e.target.result.transaction('handles', 'readonly').objectStore('handles').get('last_project').onsuccess = async (ev) => {
                const handle = ev.target.result;
                if (handle && await handle.requestPermission({ mode: 'readwrite' }) === 'granted') await loadProject(handle);
            };
        };
    }

    async function loadProject(handle) {
        projectRootHandle = handle; 
        const req = indexedDB.open('WebIDE_DB', 1);
        req.onsuccess = (e) => e.target.result.transaction('handles', 'readwrite').objectStore('handles').put(handle, 'last_project');
        
        document.getElementById('fileExplorer').innerHTML = '';
        fileIndex = []; tabs = []; renderTabs();
        document.getElementById('monaco-container').style.display = 'none';
        document.getElementById('mediaContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'flex';

        AssetManager.clear();
        await processEntry(handle, document.getElementById('fileExplorer'), "");
        await indexAllFiles(handle, "");
        
        document.getElementById('loadingOverlay').style.display = 'flex';
        const itemsToLoad = fileIndex.filter(item => {
            const ext = item.path.split('.').pop().toLowerCase();
            return AssetManager.isHeavy(ext) || AssetManager.isCode(ext);
        }).sort((a, b) => {
            const extA = a.path.split('.').pop().toLowerCase();
            const extB = b.path.split('.').pop().toLowerCase();
            const isHeavyA = AssetManager.isHeavy(extA);
            const isHeavyB = AssetManager.isHeavy(extB);
            if (isHeavyA && !isHeavyB) return -1;
            if (!isHeavyA && isHeavyB) return 1;
            return 0;
        });

        const chunkSize = 50;
        for (let i = 0; i < itemsToLoad.length; i += chunkSize) {
            const chunk = itemsToLoad.slice(i, i + chunkSize);
            await Promise.all(chunk.map(item => AssetManager.fetchAndCache(item)));
            document.getElementById('loadingText').innerText = `Loaded ${Math.min(i + chunkSize, itemsToLoad.length)} / ${itemsToLoad.length} assets...`;
        }
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    async function processEntry(handle, parent, currentPath) {
        for await (const entry of handle.values()) {
            const div = document.createElement('div');
            div.className = `tree-item ${entry.kind}`;
            div.textContent = entry.kind === 'directory' ? `üìÅ ${entry.name}` : `üìÑ ${entry.name}`;
            parent.appendChild(div);
            const fullPath = currentPath ? `${currentPath}/${entry.name}` : entry.name;
            if (entry.kind === 'directory') {
                const sub = document.createElement('div'); sub.style.display = 'none'; sub.style.paddingLeft = '15px';
                parent.appendChild(sub);
                div.onclick = () => { 
                    const open = sub.style.display === 'block'; sub.style.display = open ? 'none' : 'block'; 
                    if(!open && !sub.hasChildNodes()) processEntry(entry, sub, fullPath); 
                };
            } else { div.onclick = () => loadFile(entry, fullPath); }
        }
    }

    async function indexAllFiles(dirHandle, pathPrefix) {
        for await (const entry of dirHandle.values()) {
            const fullPath = pathPrefix ? `${pathPrefix}/${entry.name}` : entry.name;
            if (entry.kind === 'file') fileIndex.push({ handle: entry, path: fullPath });
            else await indexAllFiles(entry, fullPath);
        }
    }

    function resolvePath(currentFilePath, targetPath) {
        if (!projectRootHandle) return targetPath;
        targetPath = decodeURIComponent(targetPath);
        if (targetPath.startsWith("/")) return targetPath.substring(1);
        let baseParts = currentFilePath ? currentFilePath.split('/') : [];
        baseParts.pop();
        const targetParts = targetPath.split('/');
        for (let part of targetParts) {
            if (part === '.') continue;
            if (part === '..') baseParts.pop();
            else baseParts.push(part);
        }
        return baseParts.join('/');
    }
    
    // --- LIVE PREVIEW ---
    async function updateLivePreview() {
        if (rightPanelMode !== 'live' || !activeTabPath) return;
        const currentTab = tabs.find(t => t.path === activeTabPath);
        if (currentTab && AssetManager.isCode(activeTabPath.split('.').pop())) {
             const content = currentTab.model.getValue();
             const blob = new Blob([content], { type: AssetManager.getMimeType(activeTabPath.split('.').pop()) });
             const url = URL.createObjectURL(blob);
             if (AssetManager.cache.has(activeTabPath)) URL.revokeObjectURL(AssetManager.cache.get(activeTabPath));
             AssetManager.cache.set(activeTabPath, url);
             AssetManager.cache.set(activeTabPath.toLowerCase(), url);
        }
        let htmlContent = "";
        if (activeTabPath.endsWith('.html')) { htmlContent = editor.getValue(); } else { return; }
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        const replaceAttribute = (el, attr) => {
            if (el.hasAttribute(attr)) {
                const rawVal = el.getAttribute(attr);
                const resolvedPath = resolvePath(activeTabPath, rawVal);
                const blobUrl = AssetManager.lookup(resolvedPath);
                if (blobUrl) el.setAttribute(attr, blobUrl);
                else if (!rawVal.startsWith('http') && !rawVal.startsWith('#') && !rawVal.startsWith('data:')) el.setAttribute(attr, "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=");
            }
        };
        doc.querySelectorAll('img, script, link, audio, video, source, a').forEach(el => {
            replaceAttribute(el, 'src'); replaceAttribute(el, 'href'); replaceAttribute(el, 'poster');
        });

        const injectionScript = `
            <script>
                (function() {
                    const methods = ['log', 'error', 'warn', 'info'];
                    methods.forEach(method => {
                        const original = console[method];
                        console[method] = function(...args) {
                            original.apply(console, args);
                            if(window.parent && window.parent.runtimeLogger) {
                                window.parent.runtimeLogger(method, args);
                            }
                        };
                    });
                    window.addEventListener('error', function(e) {
                        if(window.parent && window.parent.runtimeLogger) {
                            window.parent.runtimeLogger('error', [e.message]);
                        }
                    });
                })();
                window.__CURRENT_FILE_PATH__ = "${activeTabPath}";
                window.__ASSET_MAP__ = ${JSON.stringify(Object.fromEntries(AssetManager.cache))};
                function resolveAndLookup(rawPath) {
                    if (!rawPath || typeof rawPath !== 'string') return rawPath;
                    if (rawPath.startsWith('blob:') || rawPath.startsWith('http') || rawPath.startsWith('data:')) return rawPath;
                    let cleanTarget = decodeURIComponent(rawPath.split('?')[0].split('#')[0]);
                    let resolved = "";
                    if (cleanTarget.startsWith('/')) { resolved = cleanTarget.substring(1); } 
                    else {
                        let baseParts = window.__CURRENT_FILE_PATH__ ? window.__CURRENT_FILE_PATH__.split('/') : [];
                        baseParts.pop();
                        const targetParts = cleanTarget.split('/');
                        for (let part of targetParts) {
                            if (part === '.') continue;
                            if (part === '..') { if (baseParts.length > 0) baseParts.pop(); } 
                            else { baseParts.push(part); }
                        }
                        resolved = baseParts.join('/');
                    }
                    const found = window.__ASSET_MAP__[resolved] || window.__ASSET_MAP__[resolved.toLowerCase()];
                    if(!found) return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
                    return found;
                }
                new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) { 
                                ['src', 'href'].forEach(attr => {
                                    if(node.hasAttribute(attr)) node.setAttribute(attr, resolveAndLookup(node.getAttribute(attr)));
                                });
                            }
                        });
                    });
                }).observe(document.documentElement, { childList: true, subtree: true });
                const OriginalImage = window.Image;
                window.Image = function(w, h) {
                    const img = new OriginalImage(w, h);
                    Object.defineProperty(img, 'src', {
                        get: function() { return this.getAttribute('src'); },
                        set: function(val) { this.setAttribute('src', resolveAndLookup(val)); }
                    });
                    return img;
                };
            <\/script>
        `;
        const finalHTML = injectionScript + doc.documentElement.outerHTML;
        const frame = document.getElementById('webFrame');
        frame.removeAttribute('src');
        frame.srcdoc = finalHTML;
    }
    
    function fullRefresh() { AssetManager.clear(); loadProject(projectRootHandle); }

    // --- UI HELPERS ---
    function toggleConsole() {
        const p = document.getElementById('consolePane');
        p.className = p.className.includes('open') ? 'console-pane' : 'console-pane open';
        setTimeout(() => editor.layout(), 310);
    }
    function toggleSearch() {
        const box = document.getElementById('searchBoxContainer');
        if (!box.classList.contains('visible')) {
            box.classList.add('visible'); document.getElementById('searchInput').focus();
        } else {
            box.classList.remove('visible');
            document.getElementById('fileExplorer').style.display = 'block';
            document.getElementById('searchResults').classList.remove('visible');
        }
    }
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const results = document.getElementById('searchResults');
        const explorer = document.getElementById('fileExplorer');
        if(query.length === 0) { explorer.style.display = 'block'; results.classList.remove('visible'); return; }
        explorer.style.display = 'none'; results.classList.add('visible'); results.innerHTML = '';
        const matches = fileIndex.filter(item => item.path.toLowerCase().includes(query));
        matches.forEach(item => {
            const div = document.createElement('div'); div.className = 'tree-item search-match';
            div.innerHTML = `<span>üìÑ</span> <span style="margin-left:5px; font-size:11px;">${item.path}</span>`;
            div.onclick = () => { loadFile(item.handle, item.path); toggleSearch(); };
            results.appendChild(div);
        });
    });
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); const f = document.getElementById('searchResults').firstElementChild; if(f) f.click(); }
    });
    
    function openPanel(mode) {
        const panel = document.getElementById('rightPanel');
        panel.classList.add('open'); rightPanelMode = mode; setTimeout(() => editor.layout(), 310);
        const frame = document.getElementById('webFrame');
        const urlInput = document.getElementById('urlInput');
        if (mode === 'browser') {
            document.getElementById('browserControls').style.display = 'flex'; document.getElementById('livePreviewControls').style.display = 'none';
            frame.removeAttribute('srcdoc');
            if (!frame.src || frame.src === 'about:blank') { urlInput.value = 'https://mysingingmonsters.fandom.com/wiki/My_Singing_Monsters_Wiki'; loadUrl(); }
        } else {
            document.getElementById('browserControls').style.display = 'none'; document.getElementById('livePreviewControls').style.display = 'flex';
            frame.removeAttribute('src'); frame.src = ''; updateLivePreview();
        }
    }
    function startLiveServer() { openPanel('live'); }
    function openBrowser() { openPanel('browser'); }
    function loadUrl() {
        const frame = document.getElementById('webFrame');
        let url = document.getElementById('urlInput').value;
        if (!url.startsWith('http')) url = 'https://' + url;
        if (document.getElementById('proxyCheck').checked) frame.src = 'https://corsproxy.io/?url=https://example.com';
        else frame.src = url;
    }
    function browserRefresh() { if(rightPanelMode === 'browser') loadUrl(); else updateLivePreview(); }
    function browserBack() { try { document.getElementById('webFrame').contentWindow.history.back(); } catch(e){} }
    function closeRightPanel() { document.getElementById('rightPanel').classList.remove('open'); rightPanelMode = 'none'; document.getElementById('webFrame').removeAttribute('src'); document.getElementById('webFrame').removeAttribute('srcdoc'); setTimeout(() => editor.layout(), 310); }
    
    // --- UPDATED THEME LOGIC ---
    function applyUiTheme(themeName) {
        localStorage.setItem('webIDE_currentTheme', themeName);
        let uiSettings;
        if (themeName === 'custom') {
            uiSettings = settings.customTheme;
        } else if (themeName === 'vs-dark') {
            uiSettings = { app: '#1e1e1e', sidebar: '#252526', header: '#3c3c3c', text: '#cccccc', accent: '#007acc', border: '#3e3e42', hover: '#2a2d2e', tabInactive: '#2d2d2d', tabActive: '#1e1e1e' };
        } else if (themeName === 'vs-light') {
            uiSettings = { app: '#ffffff', sidebar: '#f3f3f3', header: '#e8e8e8', text: '#333333', accent: '#007acc', border: '#cecece', hover: '#e4e4e4', tabInactive: '#e0e0e0', tabActive: '#ffffff' };
        } else if (themeName === 'dracula') {
            uiSettings = { app: '#282a36', sidebar: '#21222c', header: '#191a21', text: '#f8f8f2', accent: '#bd93f9', border: '#44475a', hover: '#44475a', tabInactive: '#343746', tabActive: '#282a36' };
        } else if (themeName === 'monokai') {
            uiSettings = { app: '#272822', sidebar: '#1e1f1c', header: '#171814', text: '#f8f8f2', accent: '#a6e22e', border: '#3e3d32', hover: '#3e3d32', tabInactive: '#2f3129', tabActive: '#272822' };
        } else if (themeName === 'solarized') {
            uiSettings = { app: '#002b36', sidebar: '#073642', header: '#002b36', text: '#839496', accent: '#268bd2', border: '#073642', hover: '#586e75', tabInactive: '#003847', tabActive: '#002b36' };
        } else if (themeName === 'synthwave') {
            uiSettings = { app: '#262335', sidebar: '#241b2f', header: '#2a2139', text: '#fff', accent: '#ff7edb', border: '#34294f', hover: '#362c50', tabInactive: '#3a314f', tabActive: '#262335' };
        } else if (themeName === 'seti') {
            uiSettings = { app: '#151718', sidebar: '#1C1F20', header: '#222526', text: '#CDD4D7', accent: '#87C38A', border: '#383A3B', hover: '#2B2D2E', tabInactive: '#222526', tabActive: '#151718' };
        } else if (themeName === 'tomorrow-night') {
            uiSettings = { app: '#1d1f21', sidebar: '#282a2e', header: '#373b41', text: '#c5c8c6', accent: '#b294bb', border: '#4e4e52', hover: '#373b41', tabInactive: '#282a2e', tabActive: '#1d1f21' };
        } else if (themeName === 'ambiance') {
            uiSettings = { app: '#1c1c1c', sidebar: '#222222', header: '#282828', text: '#f8f8f8', accent: '#e5c07b', border: '#333333', hover: '#2d2d2d', tabInactive: '#222222', tabActive: '#1c1c1c' };
        }
        document.documentElement.style.cssText = `
            --bg-app: ${uiSettings.app}; --bg-sidebar: ${uiSettings.sidebar}; --bg-header: ${uiSettings.header || uiSettings.sidebar}; --text-main: ${uiSettings.text};
            --accent: ${uiSettings.accent}; --border: ${uiSettings.border || '#3e3e42'}; --hover: ${uiSettings.hover || '#2a2d2e'}; --shadow: 0 4px 6px rgba(0,0,0,0.3);
            --tab-inactive: ${uiSettings.tabInactive || uiSettings.sidebar}; --tab-active: ${uiSettings.tabActive || uiSettings.app};
        `;
    }
    function changeTheme(themeName) {
        if (editor) monaco.editor.setTheme(themeName);
        applyUiTheme(themeName);
    }
</script>
</body>
</html>
